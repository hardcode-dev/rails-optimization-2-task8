# Задание №8

В этом задании вам нужно написать `case-study` о том как вы применили знания, полученные на курсе, к своим проектам.

## О проекте

Привет, я один из разработчиков платформы 3Commas.io. Это такой торговый терминал чтобы систематизировать все что у вас происходит на различных биржах и помогать с оптимизацией процессов
Примерно как в жизни - у вас немного денег в тинькове, чутка в альфе, где у вас крутая кредитка с милями а еще есть киви кошелек и акции в финаме. 
- Сколько у вас сейчас всего суммарно денег ? Зайти во все места и потому руками просуммировать - ад. 
- А сколько было вчера ? 
- А правильно ли вы доллары перед поездкой купили неделю назад или лучше было подождать?

Вот такую проблему мы и решаем, пока правда только в области криптовалют
Всем кто читает этот текст скидка 70% на подписку =)

Проекту 3 года, начинался как пет проджект для внутреннего использования, но потом внезапно выяснилось что всем нужно

В целом с перформансом у нас скорее хорошо, мы в lighthouse смотрим, и raygun для фронта используем, само собой ньюрелик, иногда скаут триальный, аутсорс ДБА с окметром и аутсорс админы кто также мониторит метрики в том числе по веб серверам.
Жаль только что не удается построить вовлеченность всей команды в процесс оптимизации. Есть специальный человек кто регулярно смотрит в ньюрелик ( и у кого он открыт на втором мониторе вместе с окметром постоянно ) и он уже накидывает сигнализирует о проблемах

Я занимаюсь прототипированием новых фичей (обычно очень смелых но таких что просто лендингом и сбором заявок не оценить), чтобы проверить интерес рынка, посмотреть отзывы фокус-группы также занимаюсь оптимизацией, больно бью коллег за n+1 и мемори блоаты

Судя по датам в слаке оптимизацию в проекте с применением новых знаний я сделал на 3 неделе курсе и даже оформил case-study для ребят. Отлично - меньше сейчас делать придется. 

У нас есть такое место где сводятся все балансы со всех бирж и в целом все работает хорошо - медианное количество подключенных бирж всего 3 и можно посчитать курсы в лоб, но есть дракон 95 персентиля - люди у кого десятки подключенных бирж, в основном это те, кто управляет чужими финансами. Такие пользователи очень важны, а у них дашборд открывается хоть и аяксом но все равно 10 секунд.

В нашем кэше всегда есть актуальные курсы валют и акций - этим занимаются фоновые демоны, по вебсокету получающие самые актуальные курсы - казалось бы в чем проблема пробегись по всем биржам и акциям что есть ц человека, посмотри текущий курс и нарисуй пайчарт и покажи сумму, но нет

## замер 

Для теста я взял человека у которого было 50 подключенных аккаунтов и замерил время проведения всех рассчетов, прямо в консоли на продакшене
    
    Benchmark.ms{ user.summary_account.btc_amount }
     => 6921.2161739123985

7 секунд естествено никуда не годится, особенно учитывая что есть люди у кого аккаунтов и побольше

## профилировка

Добавил в гемфайл руби-проф, require: false и разлив на прод я пошел баловаться дальше 

    require 'ruby-prof'

    result = RubyProf.profile do
        10.times { user.summary_account.btc_amount}
      end
  
      printer = RubyProf::GraphHtmlPrinter.new(result)
      printer.print(File.open('ruby_prof_reports/graph.html', 'w+'))

Подавляющее большинство времени оказалось в методе расчета цены акции в долларах `Currency.current_usdt_price` а из них 90% времени в обращении к кэшу где хранятся курсы валют
но кэш у нас быстрый, а обращений к нему больше ста тысяч
Я пошел смотреть алгоритм и выяснилось что он примерно такой 
- посмотри торгуется ли к доллару, если да то возьми курс
- посмотри что торгуется к доллару и что торгуется к текущей монете, если нашел пересечение то построй курс из цепочки
И все эти проверь торгуется ли делались запросом курсов из кэша (если есть в кэше значит торгуется)

## Исправление 1
Так как у нас есть информация обо всех парах которые торгуются на бирже то я прямо в этом методе создал из этого списка Set и дальше проверял существует ли пара прямо в сете вместо того чтобы ходить в кэш

Benchmark.ms{ user.summary_account.btc_amount }
 => 2400.3758300095797 
 
Пришлось подкрутить немного rspec и вуаля уже х2.5

Повторяем профилировку и видим что теперь мы торгуемые пары очень много раз запрашиваем из кэша ( они тоже там хранятся ) буквально на каждую акцию, а потом еще из этого генерируем Set

## Исправление 2 
Кэшируем список пар каждой биржи на время расчетов, чтобы если на какой-то бирже 100 акций, запрашивать пары один раз и сет генерировать 1 раз 

Теперь бенчмарк выдает то 2с то 700мс
О чем это говорит ? Иногда работает GC иногда нет, попробуем его отключить
    GC.disable 
    Benchmark.ms{ 10.times { user.summary_account.btc_amount}}
     => 7161.824051989242
То есть стабильно 700мс на один проход, надо проверить не сьедаем ли мы много лишней памяти

## Прежде чем перейти к памяти, проверяем не зря ли добавили сет - меняем на обычный массив, запускаем профилировщик
Результат - стало в полтора раза хуже, так что Set был правильным решением

## Проверяем память 

    
    require 'ruby-prof'
    RubyProf.measure_mode = RubyProf::ALLOCATIONS
    GC.disable
    result = RubyProf.profile do
     User.find(xxxx).summary_account.btc_amount
    end
    GC.enable

сходу можно только погрустить на тему того как много памяти ест ActiveRecord

Если бы это было прям совсем проблемой, можно было бы исхитриться и не загружать модель совсем, или поиграться с загрузкой только нужных полей, но мы уже ускорили 95 персентиль в 10 раз. 
Люди которые страдали по 7 секунд теперь получают ответ меньше чем за секунду, в оптимизации очень важный момент - вовремя остановиться, наша остановка вот здесь
