# Работа № 8  

## Вводная информация

### Описание проекта 

На данный момент я работаю над относительно новым проектом, который находится в разработке ~8 месяцев.  
Проект было решено строить сразу отталкиваясь от разделения Бэка и Фронта. 

Таким образом на стороне Бэка у нас Rails приложение, которое работает в режиме чистого API (Вьюх у нас нет).

На стороне Фронта у нас несколько приложений под Админку и Паблик часть:
- Для Паблика команда приняла решение использовать NextJS (В основном из-за встроенных инструментов для SEO)
- Для Админки используется ReactJS 

Так как проект по тихоньку разростается и усложняется вопрос перформанса становится все более актуальным. 
На данный момент никаких систем мониторинга в наличии не имеется(кроме GA, но этого явно не достатчно). 
Из-за того что мы новый продукт, то до 1.03.2020 у команды разработки стояла задача предоставить максимум функционала. 
Задача исходила из того, что это нужно Бизнес отделу для выполнения их задач, презентаций и т.д. Поэтому вопрос о перформансе системы был умышленно отодвинут.
Сейчас как раз появилось удачное время, что бы применить полученные знания на практике.
 
На данный момент перформанс при хорошем подключении интернета довольно таки не плохой.  
Наш SEO-шник снимал отчеты от Гугла(какие то показатели для SEO). И презентовал их команде пару недель назад. 
И результаты были довольно не плохими. 

На прошлой неделе после просмотра 5-й лекции я снял пару метрик с помощью `webpagetest.org` на мобильном интернете.   
И результаты сразу показали, что все очень плохо(Но не смертельно).

Как показал `webpagetest` наша точка роста это изображения. Они не кэшириются и они очень тяжеловестные. 
Но я думаю, что это не единственная точка роста. Из-за того что мы новый продукт, у нас было большое кол-во изменений по ходу разработки + не достаточно сильно делался акцент на производительности. 

Поэтому я думаю, что в проекте есть проблемы:  
- Индексы в таблице не везде присутствют
- Лишние данные присутсвуют в ответах от сервера
- У нас не настроен `http2` (инфа 100)
- Я не уверен, что мы архивируем ответ от сервера 
- У нас совершенно нет кэширования, а я точно знаю некоторые места, где оно может помочь.
- У нас не оптимальный формат изображений (на данный момент у нас `jpeg`)
- и многое другое... 

Из плюсов той ситуации, в которой мы находимся: 
- API покрыта тестами на 99.9%(но они не оптимизированы), что позволяет безопасно вносить изменения
- наконец то появилось время, которое можно (и нужно) выделить на оптимизацию
- Проект не слишком большой, поэтому он проще поддается изменениям

### Описание команды

Так как мы молодой проект, то команда у нас довольно таки мальенькая: 2 человека на фронте 1 на бэке. 
Как модно было догадаться, я тот 1 человек на бэке. 

Я работаю в Веб разработке (все время с Руби) примерно 7 лет. На самом деле я уже года 3 как фулл-стек разработчик и имею опыт 
работы с разными либами и фреймворками на фронте(Angular, React и др.).
На этом проекте я выполняю роль Тим. Лид/архитектор, честнее всего будет сказать, потому что кроме меня некому, а не потому, что я весь такой классный.


## Исследования и оптимизации

### Настройка мониторинга 

#### New Relic

Для начала я решил настроить мониторинг с помощью NewRelic.   
Это оказалось не сильно полезным в данный момент времени так как нагрузка на сервер сейчас очень низкая. 
Тем не менее удалось проанализировать текущее состояние сервера и понять, что на данный момент ответ от сервера всегда укладывается в `450 ms`, 
что на данном этапе устроило наш бюджет.   
Поэтому я просто добавил необходимые алерты, что бы в случае, когда ответы выйдут за пределы бюджета, пришло уведомление от сервера.

#### PgHero

Следующим шагом я добавил и настроил `PgHero` для мониторинга запросов и объема данных в БД. 

На данном этапе это так же не дало явного результата в виде оптимизации, но дает возможность мониторинга и быстрого реагироввния на возникающие проблемы.

#### AWS monitoring

Так как мы используем AWS ec2 инстансы для хостинга нашего продукта. 
То так же было принято решение настроить мониторинг и оповещения в случае превышения определенного лимита по
- используемому CPU(%) 
- используемому RAM
- Объем входящих данные
- Объем изходящих данные 

### Общие оптимизации
 
#### SSL && HTTP2

Так как это 100% необходимые настройки. То было принято решение настроить SSL & HTTP2 в первую очередь  
TLS протокол у нас был настроен на всех продакшн серверах, но не был настроен на development. 
Поэтому первым шагом стала настройка TLS на development серверах.
Меня очень заинтересовало как изменятся метрики, когда будет добавлено использование протоколо http2. 
Поэтому я сделал замеры с помощью `sitesped.io` на трех самых популярных страницах нашего сайта ДО внедрения http2 и после. 

И самым интересным оказалось, то что показатели в целом не сильно изменились. Некоторые учучшились, а некоторые ухудшились.  
В целом на результаты могла повлиять еще и погрешность при выполнении. Так что какой то явной выгоды от использоввани http2, пока что доказано не было.  
 
#### Brotli

После изучения алгоритма сжатия данных было принято решение перевести все сервисы с gzip на brotli 
Так как было интересно какие изменения это даст для нашего сервиса после установки, я снял метрики и сравнил их с тем что было, когда использовался gzip.

Общий объем данных немного уменьшился. Не скажу что прям очень заметно.

`Total Transfer Size` для каждой из страниц уменьшилось примерно на `20`-`30`

### Точки роста

#### 1. Изображения(format)

Главной точкой роста оказался размер изображений, которые грузятся. Мы использовали `JPEG` формат.
После ресерча было принято перейти на использование `webp` формата. 
Я добавил конвертацию изображений в `webp` формат при загрузке, а так же обработал уже имеющиеся изображения

В результате этих измеенний объем `Image Transfer Size` уменьшился в ~3 раза 
