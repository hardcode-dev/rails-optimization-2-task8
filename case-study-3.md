# Case-study оптимизации
## О проекте
Данный проект, своего рода, агрегатор по ресторанам. Тут возможен поиск ресторанов, а также возможностью заказать столик, банкет и оформить доставку еды на дом.

Проект написан на ruby. Используется версия 2.5.3. Rails 5.2.
С проектом, достаточно, давно. Моя обязанность заключается в разработке на бэкенд стороне

### Шаг 1
Сюда я сразу поставли skylight, rack-mini-profiler, pghero, ruby-prof

При посещении страницы ресторанов, pghero показал, что было бы неплохо добавить индексы

![rest_1](https://i.ibb.co/tQpfMvs/rest-0.jpg)

Взял страницу списка ресторанов, запустил ab тест с указанием параметра pp=skip (чтобы брались данные без работы гема rack-mini-profiler) 

![rest_2](https://i.ibb.co/TBSPQnC/rest-1.jpg)

Тут выходит, что на 100 запросов потребовалось 7.6 секунд. Предполагаемое кол-во запросов в секунду 13.03

Далее посмотрел на отчет skylight

![rest_3](https://i.ibb.co/L8zv82w/rest-2.jpg)

Также, зашел на страницу списка ресторанов с pp=profile-memory и профайлер показал, что views _filters.html.haml, _restaurant.html.haml и _header.html.haml потребляют больше всего памяти.

В файле _filters.html.haml оптимизировать нечего, то есть, лишние объекты, по возможности, не создаются, используются символы, если необходимо, объекты фризятся.
Но фильтров много и в каждом фильтре (по кухне, метро, услугам и т. д.) проходят циклы и формируют необходимую нам структуру.

Поэтому было принято это закешировать — мы кешируем каждый фильтр на 24 часа.

Фильтры будут меняться редко, и мы могли бы закешировать весь блок фильтров, но все же фильтры могут поменятся, поэтому мы берем все айдишники каждого фильтра, и используем его, как идентификатор

Например
```
- cache("restaurants-filter-property--#{@filters[:property].map(&:first).join('')}", expires_in: 24.hours) do
```

Также, в файле `_header.html.haml` идет формирование ссылок на города

Решил тут заменить `link_to` на обычный тег `a` и посмотреть на результаты

Как и ожидалось - `_filters` и `_header` пропали из списка.

Сейчас мы еще закешируем города в _header, так как данные меняются там достачно редко и можно избежать лишнего рендеринга

Запустив ab тест — вышли следующие результаты

![rest_4](https://i.ibb.co/02HxMzW/rest-3.jpg)

То есть, выполнилось на 1,4 секунды быстрее

Итого по этому кейсу — memory-profile по странице ресторанов ДО внесение правок говорил следующее
`Total allocated: 8511966 bytes (111485 objects)`

После
`Total allocated: 6627941 bytes (82883 objects)`

Иными словами, потребление памяти уменьшилось на 22%

### Шаг 2
Но  у нас есть еще _restaurant.html.haml 

![rest_5](https://i.ibb.co/PWrTk6J/rest-5.jpg)

Уж слишком много аллокаций.

Проанализировав view и к ней прилегающее — не удалось найти  мест, где бы создавались объекты без надобности.
Опять же, по максимальному задействованы freeze, методы мутаторы.
А также то, что рестораны не так часто изменяются, было принято решение что, каждый объект-ресторан на странице ресторанов будет закеширован

В итоге, результат выполнения AB теста
![rest_5](https://i.ibb.co/5jVxFPj/rest-6.jpg)

А memory-profile показывает
`Total allocated: 3956982 bytes (42009 objects)`

Предыдущий результат был
`Total allocated: 6627941 bytes (82883 objects)`

Уменьшилось потребление памяти от последнего результата на 40%

А skylight показал следующее
![rest_skylight](https://i.ibb.co/t8n6X7r/rest-fin.jpg)

### Итого
Общий результат по странице ресторанов такой
До
`Total allocated: 8511966 bytes (111485 objects)`

После
`Total allocated: 3956982 bytes (42009 objects)`

Общее уменьшение потребление памяти составил 53%

Здесь тоже можно смело переходить на http2, смотреть остальные места, которые можно кешировать.
Кешировать это неплохо, dev.to вообще весь обмазан кешированием и все отлично работает =)

