# Case-study оптимизации

## О проекте
Наш проект предоставляет пользователям каталог дизайнов интерьера и возможность заказать смету на ремонт.

Проекту около 3 лет, перфомансом никогда не занимались, из сервисов мониторинга ничего нет, если не ошибаюсь,
возможно только какие-то встроенные утилиты в digitalocean где мы хостимся.

Навскидку я решил начать оптимизацию с главной страницы,
пройтись по чек листу основных оптимизаций представленных в курсе и попробовать применить их.

В проекте я занимаюсь бэкендом, архитектурой бд, обработкой пользовательских данных,
а также поиск и представление каталога дизайнов для клиента.

## Актуальная проблема
В нашем проекте на главную страницу направлен основной трафик с клиентами,
поэтому очень важно чтобы она загружалась быстро.

После анализа страницы с помощью
google pagespeed мы поняли что страница загружается не так быстро как хотелось бы.

Мы решили это исправить оптимизировав систему.

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я решил использовать несколько метрик.

За основу бралась метрика sitespeed.io, иногда часть правок выкладывалась на стейдж и проверялись улучшения с помощью google pagespeed.
![a-sitespeed-result](https://raw.githubusercontent.com/badimalex/rails-optimization-task8/task-8/3a-sitespeed-result.png)

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`,
который позволил мне получать обратную связь по эффективности сделанных изменений.

Вот как я построил `feedback_loop`:

- 1 развернул local_production и настроил локальный https
- 2 включил ngrok и выложил проект в сеть
- 3 оптимизировал точки роста и улучшения предложенные утилитой sitespeed и сервисом WebPageTest
- 4 собирал изменения в маленькие релизы, выкладывал на стейдж и проверял  с помощью google pagespeed.
- 5 если прогресс подтверждался - двигался дальше, если нет откатывался и искал новые решения.

## Вникаем в детали системы, чтобы найти 20% точек роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался:

- sitespeed.io (npm package), webpagetest.org, pagespeed google, - для сбора метрик, анализа, получения рекомендаций по улучшению страницы
- Инструмент coverage в google chrome - для обнаружения и удаления лишних стилей и js
- purifycss.online - обнаружение неиспользуемого css в бандл файле
- ab (Apache HTTP benchmarking tool) - для тестирования скорости работы сервера
- gem bullet - для обнаружения n+1 запросов

Вот какие проблемы удалось найти и решить

### Находка №1 (оптимизация backend)

выключил javascript в браузере и попробовал грузить сайт с открытой консолью, смотря в логи

потестил с помощью ```ab -n 10 -c 5 127.0.0.1:3000/```

профайлинг ab benchmark

```
50% 17180 ms
```

профайлинг curl
```
Completed 200 OK in 2805ms (Views: 2717.9ms | ActiveRecord: 33.4ms)
Completed 200 OK in 2792ms (Views: 2714.1ms | ActiveRecord: 8.6ms)
Completed 200 OK in 2406ms (Views: 2331.6ms | ActiveRecord: 10.0ms)
Completed 200 OK in 2836ms (Views: 2800.8ms | ActiveRecord: 10.7ms)
```

Т.е рендеринг занимает от 1.500ms до 2.000-2.500ms

- Фикс 1:
  В логах выделил для себя 4 запроса в базу, из них формируется меню.
  Меню статическое и никогда не меняется, удалил запросы, меню захардкодил в вьюхе.

- Фикс 2:
  Обнаружил лишнее создание инстансов переменных которые не используются, отрефакторил контроллер.
  Перенес часть логики во вью.

- Фикс: 3:
  Для некоторых блоков главной страницы добавил кэширование

профайлинг ab benchmark ```50% 3809```

```
Completed 200 OK in 730ms (Views: 724.3ms | ActiveRecord: 0.0ms)
Completed 200 OK in 1181ms (Views: 1140.9ms | ActiveRecord: 0.0ms)
Completed 200 OK in 671ms (Views: 664.3ms | ActiveRecord: 0.0ms)
Completed 200 OK in 619ms (Views: 612.1ms | ActiveRecord: 0.0ms)
Completed 200 OK in 609ms (Views: 603.1ms | ActiveRecord: 0.0ms)
```

Итого: загрузка страницы ускорилась на  ~75-77%

### Находка №2 (оптимизация api)
Далее я c помощью гема bullet обнаружил в терминале n+1 запросы

- Фикс: 1:
  в основном это были ajax запросы, добавил includes, это решило проблему.

- Фикс: 2:
  Добавил кэширование для запросов к апи

Метрика: ```Processing by Api::V1::Blog::ArticlesController#index as JSON```

До: ```Completed 200 OK in 511ms (Views: 412.3ms | ActiveRecord: 21.4ms)```

После: ```Completed 200 OK in 127ms (Views: 115.7ms | ActiveRecord: 2.2ms)```

Итого: увеличение скорости на ~72%

### Находка №3 (оптимизация javascript, css)

- Фикс 1:
  Сначала я решил воспользоваться инструментом coverage в Chrome
  Онаружил загрузку 5-7 лишних js файлов, провел очистку и рефакторинг неиспользуемого кода.

- Фикс 2:
  Поиск и очистка неиспользуемых css также с помощью coverage и инструмента purifycss.online

- Фикс 3:
  Провел рефакторинг css, объединил несколько файлов в один бандл (этим сократил количество запросов к серверу),
  часть стилей используемых на других страницах подключил отдельно,
  Выделил часть inline css, по рекомендации smashingmagazine.com, положил в кэш.

Итого: метрика pagespeed.io показала улучшения в 2-3 раза по всем параметрам
(page load time, first paint, image requests, javascript transfer size)

### Находка №4 (оптимизация сервера)
- Фикс 1:
  Перевел сервер на HTTP/2 и настроил server-push.
  Часть картинок и стили перевел на server-push.

- Фикс 2:
  С помощью rake middleware, обнаружил лишние вызовы middleware неиспользуемых гемов.
  Провел очистку.

Итого: это дало улучшение показателей на графике sitespeed.io, метрика total requests сократилась в несколько раз.

## Результаты

Google pagespeed:

```Mobile: было 20% стало 80%```

```Desktop: было 65% стало 98%!```

До оптимизации

![1a-pagespeed-result](https://raw.githubusercontent.com/badimalex/rails-optimization-task8/task-8/1a-pagespeed-result.png)
![2a-pagespeed-result](https://raw.githubusercontent.com/badimalex/rails-optimization-task8/task-8/2a-pagespeed-result.png)

После оптимизации

![2b-ps](https://raw.githubusercontent.com/badimalex/rails-optimization-task8/task-8/2b-pagespeed-result.png)
![1b-ps](https://raw.githubusercontent.com/badimalex/rails-optimization-task8/task-8/1b-pagespeed-result.png)

Сравнение sitespeed.io

- Основная метрика прикладывалась в начале, здесь метрика после оптимизации

![a-sitespeed-result](https://raw.githubusercontent.com/badimalex/rails-optimization-task8/task-8/3b-sitespeed-result.png)

Сравнительная таблица прироста производительности:
| Metric                  	| Before 	| After 	|
|-------------------------	|--------	|-------	|
| Page load time          	| 6.6s   	| 2.5s  	|
| Total Transfer Size     	| 1.8MB  	| 975KB 	|
| Javascript Content Size 	| 3.6MB  	| 857KB 	|
| Total Requests          	| 116    	| 47    	|

- Ссылка на сравнение HAR-файлов: https://compare.sitespeed.io/?gist=90db4752af665c341b0b49e09cbf553b

## Защита от регресса производительности
Было бы неплохо воспользоваться утилитой которая будет ограничивать размер бандлов css, и js
и оповещать на емейл при нарушении объемов, добавил себе этот пункт в @TODO
