# Задание №8

## О проекте
Мой рабочий проект можно описать как монолит-метеорит который летит в рабочем воркфлоу постепенно отделяя от себя микросервисы. К сожалению это по большей части новый функционал, а старые очень редко покидат монолитное тело. От этого у нас есть довольно приличный кусок легаси, а с другой стороны почти иделаьно выстроенные новые микросервисы с полным покрытием тестовой базы. 
Если говорить более конкретно то у нас 2 относительно крупных приложения (админка и платформа) на руби, мобильное и веб приложение, плюс множество внутренних сервисов (в той или иной степени интеграции с основной платформой)
Проекту уже около 5-6 лет, у нас есть мониторинг (даже несколько) но обычный рабочий это Графана + Прометеус, отдельньно у нас есть Sentry, плюс разные дополнительные инструменты у разных из команд. Доступ для разработчиков есть только в Sentry, во всем остальном мы полагаемся на тесты и спускаемые сверху директивы.
Про перформанс могу сказать лишь что проблем с ним как таковых нет, есть просто отдельные места которые или уже вынесли в отдельный сервис на более подходящей технологии, или же собираются. Но в основном - большинство критических точек были перестроены. Например мы используем Elixir для работы с сокетами, и Vertica для тех моментов когда нужно выбирать большие объемы данных.
На проекте я занимаюсь зоной контакта с клиентской базой и интеграцией с сторонними сервисами (рассылки, сторонние crm). В моей ЗО относительно много легаси, и относительно много при этом больших и тяжелых выгрузок на сторонние сервисы. У меня 1,5 года опыта.

## Что было проделано/использовано/прикручено за время курса
1. В рабочей деятельности очень часто периодически выгружаем большие объемы данных в сторону третьих сервисов. SFTP или через запросы к чужому API. В рамках одной из тасок столкнулись с коллегой с моментом когда формирование одной записи для выгрузки начало занимать неприлично много времени. 
8 секунд на запись, при объеме в батча в 50к, довольно много. Рассказать про гениальный фидбэк луп не получится, benchmark, ruby-prof решили проблему за один раз.
Очень быстро нашли то что можно мемоизировать, очень быстро нашли связь которая подгружалась и тянула очень много лишнего за собой. Результат общее формирование пачки на 50к за минуту.
2. Столкнулись с проблемой недоступности одной индекс страницы в админке. Причина - рост числа сущностей. Неожиданно более плотно начали пользоваться данным инструментом и страница где отображались все объеты - перестала работать на проде.
Решение - подключили rack-mini-profiler, обнаружили даже не N+1 а N+N. Проблему решили переделав сами сущности. rack-mini-profiler - в прод не ушел, имеется ряд проблем с его интеграцией на стейдже.
3. При решении 7-8го задания в тестах был выявлен и так уже явный кандидат на оптимизацию - кусок легаси, который по большей части состоял из кучи sql вызовов и отвечал за распределение писем по рассылкам. 
Выставили таску на его оптимизацию, но беда пришла раньше - он положил немного БД и очередь и поэтому его бодро оптимизировали уже силами архитектора и тим лида чуть ли не ночью.
Как говорится - письмо позвало в дорогу. Как оказалось так как это легаси, мониторинг был не настроен на него и некоторые итерации занимали очень много времение (до 3 часов и ложились), после оптимизации - около минуты. На данный момент работаю над тем что бы закрепить этот результат хоть и чужой от деградации.

### WIP было в 7м задании но готовил к 8му (тут более дополнено)

Оптимизация тестов
1. Определимся с начальной точкой и бюджетом, а так же основной метрикой.
Замерим начальное время прогона тестов для локальной разработки для основной платформы.
Finished in 5 minutes 24.6 seconds (files took 58.21 seconds to load)
Общее время прогона тестов около 5 минут, их них 50 секунд - минута занимает подгрузка общих файлов. Исходя из этого будем отталкиватся.
Попробуем уйти от 5 минут и будем считать их бюджетом.

2. Для начал попробуем срезать преславутые 50 секунд для подгрузки приложения и зависимостей.
Проблема - любой запуск даже одного теста занимает около 50 секунд - минуты.

Время прогона небольшой группы тестов  - Finished in 14.27 seconds (files took 48.64 seconds to load)

Решение: Как оказалось у нас был установлен spring но люди которые его добавили покинули проект, а наша молодая поросль - или боится его использует или не понимает его профита.
Стал запускать тесты через спринг, КПД при разработке повысился. Появился смысл использования guard (но его пока не стал добавлять)

Результаты шага - при повторном запуске снимаем лишние 50 секунд. Гонял так тесты неделю - проблемы использования spring не нашел, попробую еще немного погонять и переубедить коллег. (при чем в CI мы его испоьзуем - ???)
Finished in 4 minutes 24.5 seconds (files took 10.45 seconds to load)

3. Попробуем еще уменьшить время прогона тестов. Посмотрим кто из тестов больше всего занимает времени - через отчет RSpecDissect выберем самые толстые тесты.
Профайлер показал что у нас в 10ке тестов - много тестов на тяжелые рейк таски единичного использования (например пересчет каких либо данных на корркетные после бага).
Промежуточное решение - задисейблить их временно
Правильное решение - вынести в отдельную группу и запускать например только в CI или руками

Результат: Finished in 2 minutes 22.5 seconds (почти в 2 раза упало время прогона)

4. Total `let` time: 01:33.598 - на данный момент основная проблема тестов. Попробуем поработаь с этим.
Да будет let_it_be! 
Результат: Получилось срезать около 30 секунд просто банальной заменой, и правкой пары тестов. При этом есть еще большое поле - перекомпановки всех тестов и еще более значительное уменьшение времени.
Total `let` time: 01:02.032 

Промежуточный итог - прогон приближается к 1 минуте 30 секундам.

5. Поработаем с FactoryDoctor и проанализируем фабрики. 
Отчет показал что у нас не так все плохо но есть ряд пятиэтажек. Попробуем переделать фабрики и убрать лишнее.
Результат - особого прироста не замечано. 

6. Поработал с 10кой самых медленных тестов еще раз, с учетом того что убрал оттуда не актуальные. 7 тестов из 10 выполнялись 4-5 секунд. Удалось при их оптимизации срезать еще около 20 секунд.
7. Обсуждаю введение гарда на тесты дольше 4 секунд для CI, а также гардов для общего времени прогона в CI. 

# Итоги и неудачные шаги.
1. Попробовал parallel_test - к сожалению в текущем ворк флоу он довольно не удобен (1 - часто бывают миграции и нужно перестраивать дополнительные базы 2 - докер не сильно позволяет его разогнать 3 - так как докер приходится довольно часто на неделе down-ить, время развертывания кажется более приоритетным). 
2. Помечай свои тесты по типу - когда каждый тест помечен гораздо удобнее понять кто жрет больше.
3. Защишай достигнутое - большинство гемов вроде stackprof уже подключено у нас на проекте но мало кто ими пользуется (и я грешной в том числе). Нужны охранительные механизмы что бы не терять прогресс.
4. Хочу добится 1 минуты -  для красивой цифры в тестах. 